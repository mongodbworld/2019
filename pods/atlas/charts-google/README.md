## Embedding Google Charts
_SA Author_: [Britton LaRoche](mailto:britton.laroche@mongodb.com)   
(Note this tutorial build's on the [Employee Tutorial](../employee))

## Tutorial Contents 
(Note: All tutorials are hands on and should take an estimated time of less than 20 minutes)
1. [MongoDB blog tutorial](../blog)
2. [Atlas Triggers and Functions: HR Employee tutorial](../employee/)
3. [Stitch Query Anywhere tutorial](../rest)
4. [Embed Atlas Charts in your app tutorial](../charts)
5. [Embed Google Charts tutorial](../charts-google) 
6. [Embed an Org Chart tutorial](../charts-org) 
7. [Host your application tutorial](../hosting) 

### Google charts overview 

The [Google charts](https://developers.google.com/chart/interactive/docs/quick_start) javascript library has a number of easily imported charting functions that you can imbed in your stitch application with minimal coding effort.  In this tutorial we show how to embed a google pie and column chart into your basic employee application.  The data is loaded directly from stitch into a data object that is passed into the draw chart function.

The result is shown below:
![Google Charts](img/googleChart.jpg "Google Charts")

Google charts are a good alternative to Atlas charts, but they do require coding and additional effort to set up.  Atlas charts require no code and can be easily created in an intuitive interface and easily embeded as an iframe.  This tutorial demonstrates that you are not limited to using only Atlas charts in yousr stitch application. In this tutorial we will be adding another set of charts from google to your stitch application.

No effort was put into beautifying the html page, no css or framework was added to the html, to keep it in its most simple and pure form. The image above was generated by selecting "file/print" from the browser menu. It may not be pretty, but its simple, elegant and powerful.  Lets get started.  

Note: the employeeChartsGoogle.html app is bare bones on purpose, if you wish to add some style after this tutorial you might want to check out the [Adding Style](../style) tutorial.

### Source file
The completed source file is in the link here [Employee Google Charts](employeeGoogleChart.html), you can click the link and copy the html into a text editor.  Change 'your-app-id' to the application displayed in your stitch console.  

```js
const client = stitch.Stitch.initializeDefaultAppClient('your-app-id');
```

Save the file as employeeChartsGoogle.html and double click to see the reports generated for your employee application.  The rest of this tutorial explains how to create this file from the original [employee.html](../employee/employee.html) covered in the [Atlas Triggers and Functions: Employee tutorial](https://github.com/brittonlaroche/MongoDB-Demos/edit/master/Stitch/employee/)

### 1. Count of employees by department
The first step is to gather the data required by the charts.  The charts will display a count of employees by department.  Lets begin by creating a new function to count the employees by department and display the results as a table.

```js
<script>
...
      function displayEmployeeCounts() {
        //We will aggregate the employee data by department and create a table with totals
        const tStrt = "<div><table><tr><th>Department</th><th>Number of Employees</th></tr>";
        const cEmployees = db.collection("employees");
        cEmployees.aggregate([{"$group":{"_id":"$department","num_employees":{"$sum":1}}}]).asArray()
          .then(docs => {
            const html = docs.map(c => "<tr><td>" +
              c._id +  "</td><td>" +
              c.num_employees + "</td><td>" +
              "</tr>").join("");
            document.getElementById("employee_counts").innerHTML = tStrt + html + "</table></div>";
          });
	}
</script>
```

Next we add a div tag ```<div id="employee_counts"></div>``` to contain the "employee_counts" table.

```html
...
     <input type="submit" onClick="addEmployee()">
      <hr>
        <div id="employee_counts"></div>
      <hr>
        Employee List:
      <hr>
        <div id="employees"></div>
  </body>
...
```

After the java script code and div are added to the html we are now ready to call the function from the load function already in place, we simply add ```.then(displayEmployeeCounts)```.

```js
<script>
...
    function displayEmployeesOnLoad() {
      client.auth
        .loginWithCredential(new stitch.AnonymousCredential())
        .then(displayEmployeeCounts)
        .then(displayEmployees)
        .catch(console.error);
    }
...
</script>
```
Save the modified html file and double click it, or refresh the browser to see the employee counts by department.

### 2. Importing Google Charts
Google charts are created in three steps.  The first step requires importing the javascript library form google.  Next we specify the chart type.  We then load the chart data into a data table object and pass that data object into the charts draw function. Lets begin by importing the chart's java script library from gooogle.  We add the import in the header section of the html right after we import the stitch sdk.

```html
<html>
  <head>
    <script src="https://s3.amazonaws.com/stitch-sdks/js/bundles/4.4.0/stitch.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    ...
```

Next we load the corechart package ```google.charts.load('current', {'packages':['corechart']});``` as we initialize the variables for our functions.

```html
<html>
  <head>
    <script src="https://s3.amazonaws.com/stitch-sdks/js/bundles/4.4.0/stitch.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
      const client = stitch.Stitch.initializeDefaultAppClient('your-app-id');
      const db = client.getServiceClient(stitch.RemoteMongoClient.factory,
      "mongodb-atlas").db('HR');
      google.charts.load('current', {'packages':['corechart']});
	...
```

### 3. Drawing google charts
Now that we have the chart objects loaded its time to write the aggregation function to load the chart data and draw the charts.  We have two charts sharing the same data.  We have a pie chart and a column chart.  We create them by assignng a variable and initializing the google pie chart and column chart respectively. As part of the initialization process we pass in the id for the div tag in the html where the chart will be rendered.
```js
...
    var chartPie = new google.visualization.PieChart(document.getElementById('employee_piechart'));
    var chartColumn = new google.visualization.ColumnChart(document.getElementById('employee_columnchart'));
...
```


After we have initialized the chart objects we create a new data table object to store the data.  Then we add two columns one for the department name and the other for the employee count.

```js
...
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Department');
    data.addColumn('number', 'EmployeeCount');
...	
```
The next step involves calling stitch with an aggregation function to gather the data from the Atlas database.  We get the result set which contains a department name and employee count for each department. We use a "forEach" loop reading each record and storing it in the data table.  The "id" field is used as the "aggregation id" to perform the "group by." For this query we "group by" the department name and therefor department is the "id" field.

```js
cEmployees.aggregate([{"$group":{"_id":"$department","num_employees":{"$sum":1}}}]).asArray()
    .then(docs => {
       docs.forEach( function(myDoc) {
         data.addRow([ myDoc._id , myDoc.num_employees ] );
       });
			....
    });
```

After we create the data table and load it with data we are ready to specify the chart options and draw the table.  The completed function is shown below.

```js
  function drawEmployeeCountChart() {
    var chartPie = new google.visualization.PieChart(document.getElementById('employee_piechart'));
    var chartColumn = new google.visualization.ColumnChart(document.getElementById('employee_columnchart'));
    var data = new google.visualization.DataTable();
      data.addColumn('string', 'Department');
      data.addColumn('number', 'EmployeeCount');
      //Get the data to draw the chart from MongoDB, aggregate the employee data by department
      const cEmployees = db.collection("employees");
        cEmployees.aggregate([{"$group":{"_id":"$department","num_employees":{"$sum":1}}}]).asArray()
          .then(docs => {
            docs.forEach( function(myDoc) {
              data.addRow([ myDoc._id , myDoc.num_employees ] );
            });
            // Create the chart.
            var options = {
              title: 'Employee Counts By Department',
              is3D: true,
              allowHtml:true
            };
            chartPie.draw(data, options);
            chartColumn.draw(data, options);
          });
  }
```

One last step is to add in the div tags for the charts.  We would like to view the two charts side by side so we include them in an html table.  We place them above the html table that provided the counts in our first step.

```js
...
      <hr>
	  <table><tr><td><div id="employee_piechart"></div><td><td><div id="employee_columnchart"></div></tr>
	  </table>
	  <div id="employee_counts"></div>
      <hr>
	  Employee List:
      <hr>
	  <div id="employees"></div>
  </body>
</html>
```
### 4. Calling the function to draw the charts
The final step is to draw the chart when the page loads.  We currently have a load function to piggy back on, we add the following line of code to the load script. 

```js
	.then(drawEmployeeCountChart)
```

We will login, draw the charts, display the employee counts and then list the employees.  Here is the new load script.

```js
        function displayEmployeesOnLoad() {
          client.auth
            .loginWithCredential(new stitch.AnonymousCredential())
            .then(drawEmployeeCountChart)
            .then(displayEmployeeCounts)
            .then(displayEmployees)
            .catch(console.error);
        }
```

## Next Steps
Check out the next stitch tutorial on adding an org chart to your application: [Embedding an Org Chart](../charts-org)!
